<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>busio &mdash; Mavlite 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/styles.css" type="text/css" />
      <link rel="stylesheet" href="../_static/dark.css" type="text/css" />
      <link rel="stylesheet" href="../_static/light.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/script.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../contents.html" class="icon icon-home"> Mavlite
            <img src="../_static/mavlite.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../contents.html">Mavlite</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../contents.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>busio</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for busio</h1><div class="highlight"><pre>
<span></span><span class="c1"># SPDX-FileCopyrightText: 2021 Melissa LeBlanc-Williams for Adafruit Industries</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: MIT</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">`busio` - Bus protocol support like I2C and SPI</span>
<span class="sd">=================================================</span>

<span class="sd">See `CircuitPython:busio` in CircuitPython for more details.</span>

<span class="sd">* Author(s): cefn</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">threading</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">threading</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># pylint: disable=unused-import</span>
<span class="kn">import</span> <span class="nn">adafruit_platformdetect.constants.boards</span> <span class="k">as</span> <span class="nn">ap_board</span>
<span class="kn">import</span> <span class="nn">adafruit_platformdetect.constants.chips</span> <span class="k">as</span> <span class="nn">ap_chip</span>
<span class="kn">from</span> <span class="nn">adafruit_blinka</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">Lockable</span><span class="p">,</span> <span class="n">agnostic</span>
<span class="kn">from</span> <span class="nn">adafruit_blinka.agnostic</span> <span class="kn">import</span> <span class="n">board_id</span><span class="p">,</span> <span class="n">detector</span>

<span class="c1"># pylint: disable=import-outside-toplevel,too-many-branches,too-many-statements</span>
<span class="c1"># pylint: disable=too-many-arguments,too-many-function-args,too-many-return-statements</span>


<span class="k">class</span> <span class="nc">I2C</span><span class="p">(</span><span class="n">Lockable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Busio I2C Class for CircuitPython Compatibility. Used</span>
<span class="sd">    for both MicroPython and Linux.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scl</span><span class="p">,</span> <span class="n">sda</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">scl</span><span class="p">,</span> <span class="n">sda</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scl</span><span class="p">,</span> <span class="n">sda</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deinit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">ftdi_ft232h</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.ftdi_mpsse.mpsse.i2c</span> <span class="kn">import</span> <span class="n">I2C</span> <span class="k">as</span> <span class="n">_I2C</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">binho_nova</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.nova.i2c</span> <span class="kn">import</span> <span class="n">I2C</span> <span class="k">as</span> <span class="n">_I2C</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">microchip_mcp2221</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.mcp2221.i2c</span> <span class="kn">import</span> <span class="n">I2C</span> <span class="k">as</span> <span class="n">_I2C</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">greatfet_one</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.nxp_lpc4330.i2c</span> <span class="kn">import</span> <span class="n">I2C</span> <span class="k">as</span> <span class="n">_I2C</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">pico_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.i2c</span> <span class="kn">import</span> <span class="n">I2C_Pico</span> <span class="k">as</span> <span class="n">_I2C</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">scl</span><span class="p">,</span> <span class="n">sda</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">feather_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.i2c</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">I2C_Feather</span> <span class="k">as</span> <span class="n">_I2C</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">scl</span><span class="p">,</span> <span class="n">sda</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">qtpy_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.i2c</span> <span class="kn">import</span> <span class="n">I2C_QTPY</span> <span class="k">as</span> <span class="n">_I2C</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">scl</span><span class="p">,</span> <span class="n">sda</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">itsybitsy_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.i2c</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">I2C_ItsyBitsy</span> <span class="k">as</span> <span class="n">_I2C</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">scl</span><span class="p">,</span> <span class="n">sda</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">macropad_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.i2c</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">I2C_MacroPad</span> <span class="k">as</span> <span class="n">_I2C</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">scl</span><span class="p">,</span> <span class="n">sda</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">qt2040_trinkey_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.i2c</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">I2C_QT2040_Trinkey</span> <span class="k">as</span> <span class="n">_I2C</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">scl</span><span class="p">,</span> <span class="n">sda</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">chip</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">ap_chip</span><span class="o">.</span><span class="n">RP2040</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040.i2c</span> <span class="kn">import</span> <span class="n">I2C</span> <span class="k">as</span> <span class="n">_I2C</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">scl</span><span class="p">,</span> <span class="n">sda</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">any_embedded_linux</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.generic_linux.i2c</span> <span class="kn">import</span> <span class="n">I2C</span> <span class="k">as</span> <span class="n">_I2C</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">ftdi_ft2232h</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.ftdi_mpsse.mpsse.i2c</span> <span class="kn">import</span> <span class="n">I2C</span> <span class="k">as</span> <span class="n">_I2C</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.generic_micropython.i2c</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">I2C</span> <span class="k">as</span> <span class="n">_I2C</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">microcontroller.pin</span> <span class="kn">import</span> <span class="n">i2cPorts</span>

        <span class="k">for</span> <span class="n">portId</span><span class="p">,</span> <span class="n">portScl</span><span class="p">,</span> <span class="n">portSda</span> <span class="ow">in</span> <span class="n">i2cPorts</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># pylint: disable=unexpected-keyword-arg</span>
                <span class="k">if</span> <span class="n">scl</span> <span class="o">==</span> <span class="n">portScl</span> <span class="ow">and</span> <span class="n">sda</span> <span class="o">==</span> <span class="n">portSda</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span> <span class="o">=</span> <span class="n">_I2C</span><span class="p">(</span><span class="n">portId</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_I2C</span><span class="o">.</span><span class="n">MASTER</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="c1"># pylint: enable=unexpected-keyword-arg</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No Hardware I2C on (scl,sda)=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">Valid I2C ports: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">scl</span><span class="p">,</span> <span class="n">sda</span><span class="p">),</span> <span class="n">i2cPorts</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">threading</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">deinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deinitialization&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">threading</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">threading</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deinit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan for attached devices&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">readfrom_into</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read from a device at specified address into a buffer&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">buffer</span><span class="p">)[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># remove for efficiency later</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span><span class="o">.</span><span class="n">readfrom_into</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">writeto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write to a device at specified address from a buffer&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">buffer</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">buffer</span><span class="p">)[</span><span class="n">start</span><span class="p">:],</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">buffer</span><span class="p">)[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">writeto_then_readfrom</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">address</span><span class="p">,</span>
        <span class="n">buffer_out</span><span class="p">,</span>
        <span class="n">buffer_in</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">out_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">out_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">in_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">in_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;Write to a device at specified address from a buffer then read</span>
<span class="sd">        from a device at specified address into a buffer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i2c</span><span class="o">.</span><span class="n">writeto_then_readfrom</span><span class="p">(</span>
            <span class="n">address</span><span class="p">,</span>
            <span class="n">buffer_out</span><span class="p">,</span>
            <span class="n">buffer_in</span><span class="p">,</span>
            <span class="n">out_start</span><span class="o">=</span><span class="n">out_start</span><span class="p">,</span>
            <span class="n">out_end</span><span class="o">=</span><span class="n">out_end</span><span class="p">,</span>
            <span class="n">in_start</span><span class="o">=</span><span class="n">in_start</span><span class="p">,</span>
            <span class="n">in_end</span><span class="o">=</span><span class="n">in_end</span><span class="p">,</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">SPI</span><span class="p">(</span><span class="n">Lockable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Busio SPI Class for CircuitPython Compatibility. Used</span>
<span class="sd">    for both MicroPython and Linux.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">MOSI</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">MISO</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deinit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">ftdi_ft232h</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.ftdi_mpsse.mpsse.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.ftdi_mpsse.ft232h.pin</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">SCK</span><span class="p">,</span>
                <span class="n">MOSI</span><span class="p">,</span>
                <span class="n">MISO</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span> <span class="o">=</span> <span class="n">_SPI</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCK</span><span class="p">,</span> <span class="n">MOSI</span><span class="p">,</span> <span class="n">MISO</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">binho_nova</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.nova.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.nova.pin</span> <span class="kn">import</span> <span class="n">SCK</span><span class="p">,</span> <span class="n">MOSI</span><span class="p">,</span> <span class="n">MISO</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span> <span class="o">=</span> <span class="n">_SPI</span><span class="p">(</span><span class="n">clock</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCK</span><span class="p">,</span> <span class="n">MOSI</span><span class="p">,</span> <span class="n">MISO</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">greatfet_one</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.nxp_lpc4330.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.nxp_lpc4330.pin</span> <span class="kn">import</span> <span class="n">SCK</span><span class="p">,</span> <span class="n">MOSI</span><span class="p">,</span> <span class="n">MISO</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span> <span class="o">=</span> <span class="n">_SPI</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCK</span><span class="p">,</span> <span class="n">MOSI</span><span class="p">,</span> <span class="n">MISO</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">pico_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.spi</span> <span class="kn">import</span> <span class="n">SPI_Pico</span> <span class="k">as</span> <span class="n">_SPI</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span> <span class="o">=</span> <span class="n">_SPI</span><span class="p">(</span><span class="n">clock</span><span class="p">)</span>  <span class="c1"># this is really all that&#39;s needed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">)</span>  <span class="c1"># will determine MOSI/MISO from clock</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">feather_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.spi</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">SPI_Feather</span> <span class="k">as</span> <span class="n">_SPI</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span> <span class="o">=</span> <span class="n">_SPI</span><span class="p">(</span><span class="n">clock</span><span class="p">)</span>  <span class="c1"># this is really all that&#39;s needed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">)</span>  <span class="c1"># will determine MOSI/MISO from clock</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">itsybitsy_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.spi</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">SPI_ItsyBitsy</span> <span class="k">as</span> <span class="n">_SPI</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span> <span class="o">=</span> <span class="n">_SPI</span><span class="p">(</span><span class="n">clock</span><span class="p">)</span>  <span class="c1"># this is really all that&#39;s needed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">)</span>  <span class="c1"># will determine MOSI/MISO from clock</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">macropad_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.spi</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">SPI_MacroPad</span> <span class="k">as</span> <span class="n">_SPI</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span> <span class="o">=</span> <span class="n">_SPI</span><span class="p">(</span><span class="n">clock</span><span class="p">)</span>  <span class="c1"># this is really all that&#39;s needed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">)</span>  <span class="c1"># will determine MOSI/MISO from clock</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">qtpy_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.spi</span> <span class="kn">import</span> <span class="n">SPI_QTPY</span> <span class="k">as</span> <span class="n">_SPI</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span> <span class="o">=</span> <span class="n">_SPI</span><span class="p">(</span><span class="n">clock</span><span class="p">)</span>  <span class="c1"># this is really all that&#39;s needed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">)</span>  <span class="c1"># will determine MOSI/MISO from clock</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">chip</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">ap_chip</span><span class="o">.</span><span class="n">RP2040</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span> <span class="o">=</span> <span class="n">_SPI</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">MOSI</span><span class="p">,</span> <span class="n">MISO</span><span class="p">)</span>  <span class="c1"># Pins configured on instantiation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">clock</span><span class="p">)</span>  <span class="c1"># These don&#39;t matter, they&#39;re discarded</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">any_embedded_linux</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.generic_linux.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">ftdi_ft2232h</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.ftdi_mpsse.mpsse.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.generic_micropython.spi</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">microcontroller.pin</span> <span class="kn">import</span> <span class="n">spiPorts</span>

        <span class="k">for</span> <span class="n">portId</span><span class="p">,</span> <span class="n">portSck</span><span class="p">,</span> <span class="n">portMosi</span><span class="p">,</span> <span class="n">portMiso</span> <span class="ow">in</span> <span class="n">spiPorts</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">portSck</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">MOSI</span> <span class="ow">in</span> <span class="p">(</span><span class="n">portMosi</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Clock is required!</span>
                <span class="ow">and</span> <span class="n">MISO</span> <span class="ow">in</span> <span class="p">(</span><span class="n">portMiso</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># But can do with just output</span>
            <span class="p">):</span>  <span class="c1"># Or just input</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span> <span class="o">=</span> <span class="n">_SPI</span><span class="p">(</span><span class="n">portId</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">(</span><span class="n">portSck</span><span class="p">,</span> <span class="n">portMosi</span><span class="p">,</span> <span class="n">portMiso</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No Hardware SPI on (SCLK, MOSI, MISO)=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">Valid SPI ports:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">MOSI</span><span class="p">,</span> <span class="n">MISO</span><span class="p">),</span> <span class="n">spiPorts</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">polarity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bits</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the configuration&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">any_nanopi</span> <span class="ow">and</span> <span class="n">detector</span><span class="o">.</span><span class="n">chip</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">ap_chip</span><span class="o">.</span><span class="n">SUN8I</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.generic_linux.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">ftdi_ft232h</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.ftdi_mpsse.mpsse.spi</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">ftdi_ft2232h</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.ftdi_mpsse.mpsse.spi</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">binho_nova</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.nova.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">greatfet_one</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.nxp_lpc4330.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">any_lubancat</span> <span class="ow">and</span> <span class="n">detector</span><span class="o">.</span><span class="n">chip</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">ap_chip</span><span class="o">.</span><span class="n">IMX6ULL</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.generic_linux.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">pico_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.spi</span> <span class="kn">import</span> <span class="n">SPI_Pico</span> <span class="k">as</span> <span class="n">_SPI</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">feather_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.spi</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">SPI_Feather</span> <span class="k">as</span> <span class="n">_SPI</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">itsybitsy_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.spi</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">SPI_ItsyBitsy</span> <span class="k">as</span> <span class="n">_SPI</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">macropad_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.spi</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">SPI_MacroPad</span> <span class="k">as</span> <span class="n">_SPI</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">qtpy_u2if</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040_u2if.spi</span> <span class="kn">import</span> <span class="n">SPI_QTPY</span> <span class="k">as</span> <span class="n">_SPI</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">chip</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">ap_chip</span><span class="o">.</span><span class="n">RP2040</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">any_embedded_linux</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.generic_linux.spi</span> <span class="kn">import</span> <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.generic_micropython.spi</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">SPI</span> <span class="k">as</span> <span class="n">_SPI</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
            <span class="c1"># TODO check if #init ignores MOSI=None rather than unsetting, to save _pinIds attribute</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                <span class="n">baudrate</span><span class="o">=</span><span class="n">baudrate</span><span class="p">,</span>
                <span class="n">polarity</span><span class="o">=</span><span class="n">polarity</span><span class="p">,</span>
                <span class="n">phase</span><span class="o">=</span><span class="n">phase</span><span class="p">,</span>
                <span class="n">bits</span><span class="o">=</span><span class="n">bits</span><span class="p">,</span>
                <span class="n">firstbit</span><span class="o">=</span><span class="n">_SPI</span><span class="o">.</span><span class="n">MSB</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;First call try_lock()&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deinitialization&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pinIds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the baud rate if implemented&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span><span class="o">.</span><span class="n">frequency</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Frequency attribute not implemented for this platform&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write to the SPI device&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">write_value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read from the SPI device into a buffer&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">write_value</span><span class="o">=</span><span class="n">write_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_readinto</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">buffer_out</span><span class="p">,</span> <span class="n">buffer_in</span><span class="p">,</span> <span class="n">out_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">in_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_end</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write to the SPI device and read from the SPI device into a buffer&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spi</span><span class="o">.</span><span class="n">write_readinto</span><span class="p">(</span>
            <span class="n">buffer_out</span><span class="p">,</span> <span class="n">buffer_in</span><span class="p">,</span> <span class="n">out_start</span><span class="p">,</span> <span class="n">out_end</span><span class="p">,</span> <span class="n">in_start</span><span class="p">,</span> <span class="n">in_end</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">UART</span><span class="p">(</span><span class="n">Lockable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Busio UART Class for CircuitPython Compatibility. Used</span>
<span class="sd">    for MicroPython and a few other non-Linux boards.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Parity</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parity Enumeration&quot;&quot;&quot;</span>

        <span class="k">pass</span>  <span class="c1"># pylint: disable=unnecessary-pass</span>

    <span class="n">Parity</span><span class="o">.</span><span class="n">ODD</span> <span class="o">=</span> <span class="n">Parity</span><span class="p">()</span>
    <span class="n">Parity</span><span class="o">.</span><span class="n">EVEN</span> <span class="o">=</span> <span class="n">Parity</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tx</span><span class="p">,</span>
        <span class="n">rx</span><span class="p">,</span>
        <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">,</span>
        <span class="n">bits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">parity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">receiver_buffer_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="n">flow</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">any_embedded_linux</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;busio.UART not supported on this platform. Please use pyserial instead.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">binho_nova</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.nova.uart</span> <span class="kn">import</span> <span class="n">UART</span> <span class="k">as</span> <span class="n">_UART</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">greatfet_one</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.nxp_lpc4330.uart</span> <span class="kn">import</span> <span class="n">UART</span> <span class="k">as</span> <span class="n">_UART</span>
        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">chip</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">ap_chip</span><span class="o">.</span><span class="n">RP2040</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">adafruit_blinka.microcontroller.rp2040.uart</span> <span class="kn">import</span> <span class="n">UART</span> <span class="k">as</span> <span class="n">_UART</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">UART</span> <span class="k">as</span> <span class="n">_UART</span>

        <span class="kn">from</span> <span class="nn">microcontroller.pin</span> <span class="kn">import</span> <span class="n">uartPorts</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">baudrate</span> <span class="o">=</span> <span class="n">baudrate</span>

        <span class="k">if</span> <span class="n">flow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># default 0</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Parameter &#39;</span><span class="si">{}</span><span class="s2">&#39; unsupported on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;flow&quot;</span><span class="p">,</span> <span class="n">agnostic</span><span class="o">.</span><span class="n">board_id</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># translate parity flag for Micropython</span>
        <span class="k">if</span> <span class="n">parity</span> <span class="ow">is</span> <span class="n">UART</span><span class="o">.</span><span class="n">Parity</span><span class="o">.</span><span class="n">ODD</span><span class="p">:</span>
            <span class="n">parity</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">parity</span> <span class="ow">is</span> <span class="n">UART</span><span class="o">.</span><span class="n">Parity</span><span class="o">.</span><span class="n">EVEN</span><span class="p">:</span>
            <span class="n">parity</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">parity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid parity&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">chip</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">ap_chip</span><span class="o">.</span><span class="n">RP2040</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uart</span> <span class="o">=</span> <span class="n">_UART</span><span class="p">(</span>
                <span class="n">tx</span><span class="p">,</span>
                <span class="n">rx</span><span class="p">,</span>
                <span class="n">baudrate</span><span class="o">=</span><span class="n">baudrate</span><span class="p">,</span>
                <span class="n">bits</span><span class="o">=</span><span class="n">bits</span><span class="p">,</span>
                <span class="n">parity</span><span class="o">=</span><span class="n">parity</span><span class="p">,</span>
                <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check tx and rx have hardware support</span>
            <span class="k">for</span> <span class="n">portId</span><span class="p">,</span> <span class="n">portTx</span><span class="p">,</span> <span class="n">portRx</span> <span class="ow">in</span> <span class="n">uartPorts</span><span class="p">:</span>  <span class="c1">#</span>
                <span class="k">if</span> <span class="n">portTx</span> <span class="o">==</span> <span class="n">tx</span> <span class="ow">and</span> <span class="n">portRx</span> <span class="o">==</span> <span class="n">rx</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_uart</span> <span class="o">=</span> <span class="n">_UART</span><span class="p">(</span>
                        <span class="n">portId</span><span class="p">,</span>
                        <span class="n">baudrate</span><span class="p">,</span>
                        <span class="n">bits</span><span class="o">=</span><span class="n">bits</span><span class="p">,</span>
                        <span class="n">parity</span><span class="o">=</span><span class="n">parity</span><span class="p">,</span>
                        <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                        <span class="n">read_buf_len</span><span class="o">=</span><span class="n">receiver_buffer_size</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;No Hardware UART on (tx,rx)=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">Valid UART ports: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">rx</span><span class="p">),</span> <span class="n">uartPorts</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">deinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deinitialization&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">binho_nova</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uart</span><span class="o">.</span><span class="n">deinit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uart</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbytes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read from the UART&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uart</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nbytes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read from the UART into a buffer&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uart</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a line of characters up to a newline charater from the UART&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uart</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write to the UART from a buffer&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uart</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022 Kevin Eales, Cameron Clarke.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>