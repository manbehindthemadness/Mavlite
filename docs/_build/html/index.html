<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>About &mdash; Mavlite 0.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/styles.css" type="text/css" />
      <link rel="stylesheet" href="_static/dark.css" type="text/css" />
      <link rel="stylesheet" href="_static/light.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/script.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="contents.html" class="icon icon-home"> Mavlite
            <img src="_static/mavlite.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">About</a></li>
<li><a class="reference internal" href="#system-requirements">System requirements</a><ul>
<li><a class="reference internal" href="#tested-hardware">Tested hardware</a></li>
</ul>
</li>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a><ul>
<li><a class="reference internal" href="#micropython">micropython</a></li>
<li><a class="reference internal" href="#circuitpython">circuitpython</a></li>
<li><a class="reference internal" href="#examples">examples</a></li>
<li><a class="reference internal" href="#documentation">documentation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#general">General</a></li>
<li><a class="reference internal" href="#id1">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#links">Links</a></li>
<li><a class="reference internal" href="#notes">Notes</a></li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="contents.html">Mavlite</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="contents.html" class="icon icon-home"></a> &raquo;</li>
      <li>About</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <img alt="_images/mavlite_sphinx.png" src="_images/mavlite_sphinx.png" />
<div class="toctree-wrapper compound">
</div>
<section id="about">
<h1>About<a class="headerlink" href="#about" title="Permalink to this heading">¶</a></h1>
<p>Mavlite is an attempt to make a fully elective, asynchronous, and light-weight Mavlink module for micropython and circuitpython.</p>
</section>
<section id="system-requirements">
<h1>System requirements<a class="headerlink" href="#system-requirements" title="Permalink to this heading">¶</a></h1>
<p>As of the time of this writing Mavlink uses roughly 45kb of flash and as little as 30kb of memory.
<em>Note: memory consumption is subject to change based on the number of message includes that are in use.</em></p>
<section id="tested-hardware">
<h2>Tested hardware<a class="headerlink" href="#tested-hardware" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>XIAO rp2040</p></li>
<li><p>ESP32 Standard</p></li>
</ul>
</section>
</section>
<section id="prerequisites">
<h1>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading">¶</a></h1>
<section id="micropython">
<h2>micropython<a class="headerlink" href="#micropython" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>uasyncio</dt><dd><ul>
<li><p><a class="reference external" href="https://github.com/peterhinch/micropython-async">https://github.com/peterhinch/micropython-async</a></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="circuitpython">
<h2>circuitpython<a class="headerlink" href="#circuitpython" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>busio</dt><dd><ul>
<li><p><a class="reference external" href="https://github.com/adafruit/Adafruit_BusIO">https://github.com/adafruit/Adafruit_BusIO</a></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>board</dt><dd><ul>
<li><p><a class="reference external" href="https://docs.circuitpython.org/en/latest/shared-bindings/support_matrix.html">https://docs.circuitpython.org/en/latest/shared-bindings/support_matrix.html</a></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>asyncio</dt><dd><ul>
<li><p><a class="reference external" href="https://github.com/adafruit/Adafruit_CircuitPython_asyncio">https://github.com/adafruit/Adafruit_CircuitPython_asyncio</a></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="examples">
<h2>examples<a class="headerlink" href="#examples" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>adafruit_tca9548a</dt><dd><ul>
<li><p><a class="reference external" href="https://github.com/adafruit/Adafruit_CircuitPython_TCA9548A">https://github.com/adafruit/Adafruit_CircuitPython_TCA9548A</a></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>adafruit_vl53l1x</dt><dd><ul>
<li><p><a class="reference external" href="https://github.com/adafruit/Adafruit_CircuitPython_VL53L1X">https://github.com/adafruit/Adafruit_CircuitPython_VL53L1X</a></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="documentation">
<h2>documentation<a class="headerlink" href="#documentation" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>sphinx&gt;=2.4</p></li>
<li><p>sphinx-copybutton</p></li>
<li><p>sphinx-issues&gt;=3.0.1</p></li>
<li><p>sphinx-removed-in</p></li>
<li><p>sphinx-rtd-theme&gt;=1.0</p></li>
<li><p>sphinxext-opengraph</p></li>
</ul>
</section>
</section>
<section id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h1>
<section id="general">
<h2>General<a class="headerlink" href="#general" title="Permalink to this heading">¶</a></h2>
<p><strong>Message includes</strong></p>
<p>As the Mavlink dialect files are far too large for general microcontrollers to use, Mavlite includes them based on
message_ids that are specified in a list object passed during init. Message definitions can be found in the Mavlink
documentation <em>(see links section)</em>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mavlite</span> <span class="kn">import</span> <span class="n">MavLink</span>

<span class="c1"># Create the mavlink object and include the definitions of the DISTANCE_SENSOR message</span>
<span class="n">ml</span> <span class="o">=</span> <span class="n">MavLink</span><span class="p">(</span>
    <span class="n">message_ids</span><span class="o">=</span><span class="p">[</span>  <span class="c1"># Message includes.</span>
        <span class="mi">132</span><span class="p">,</span>  <span class="c1"># DISTANCE_SENSOR</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Command callbacks</strong></p>
<p>Incoming commands are handled in the form of callback executions and are defined in a dict object passed during init. Commands
are required to accept exactly seven arguments, the definition of these arguments is specific to the command <em>(see
links section)</em>. In addition to specific arguments, commands must return three values: <code class="docutils literal notranslate"><span class="pre">result</span></code> | <code class="docutils literal notranslate"><span class="pre">progress</span></code> | <code class="docutils literal notranslate"><span class="pre">result2</span></code>.
The command callback will be executed when the specified command is received by the <code class="docutils literal notranslate"><span class="pre">command_listener</span></code> task loop.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mavlite</span> <span class="kn">import</span> <span class="n">MavLink</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">reboot</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   This is a simple example of an incoming command callback function.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="c1"># A real command should evaluate the 7 bytes of param data that will be passed as args.</span>
   <span class="kn">import</span> <span class="nn">microcontroller</span>
   <span class="n">microcontroller</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
   <span class="c1"># Any other command would need to return status information.</span>
   <span class="c1"># return 0, 0, 0</span>

<span class="n">ml</span> <span class="o">=</span> <span class="n">MavLink</span><span class="p">(</span>
   <span class="n">callbacks</span><span class="o">=</span><span class="p">{</span>  <span class="c1"># Command callbacks.</span>
      <span class="mi">246</span><span class="p">:</span> <span class="n">reboot</span>
   <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Task loops</strong></p>
<p>Selective task loops can be called from <code class="docutils literal notranslate"><span class="pre">mavlite.Mavlink.io_buffers</span></code> This returns a tuple of asynchronous functions
that can be fed directly into tasks:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">write</span> <span class="pre">loop</span></code> Provides outgoing packet transmission buffer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">read_loop</span></code> Provides incoming packet reception buffer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">heartbeat_loop</span></code> Sends a heartbeat packet at 1hz into the write buffer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">command_listener</span></code> Checks the read buffer for specific commands and executes their respective callback functions</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mavlite</span> <span class="kn">import</span> <span class="n">MavLink</span><span class="p">,</span> <span class="n">UART</span>

<span class="n">_uart</span> <span class="o">=</span> <span class="n">UART</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="n">board</span><span class="o">.</span><span class="n">TX</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="n">board</span><span class="o">.</span><span class="n">RX</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">230400</span><span class="p">)</span>

<span class="n">ml</span> <span class="o">=</span> <span class="n">MavLink</span><span class="p">(</span>
 <span class="n">message_ids</span><span class="o">=</span><span class="p">[</span>  <span class="c1"># Message includes.</span>
     <span class="mi">132</span><span class="p">,</span>  <span class="c1"># DISTANCE_SENSOR</span>
   <span class="p">],</span>
<span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">read</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Test mainloop.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ml</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">(</span><span class="n">_uart</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># [write_loop, read_loop, heartbeat_loop, command_listener]</span>
   <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>


<span class="n">lidar</span> <span class="o">=</span> <span class="n">LiDAR</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">lidar</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
</pre></div>
</div>
<p><strong>Command syntax</strong></p>
<p>Sending a command can be achieved using <code class="docutils literal notranslate"><span class="pre">mavlite.MavLink.send_command</span></code>. This will transmit the command to the write buffer and attempt to return the ACK, providing
it’s available and has not timed out. Each mavlink command has seven unique params that must be transmitted, the definitions of these can be found in the documentation
provided in the links section.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">m</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
     <span class="n">command_id</span><span class="o">=</span><span class="mi">246</span><span class="p">,</span>
     <span class="n">target_system</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
     <span class="n">target_component</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
     <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
     <span class="n">debug</span><span class="o">=</span><span class="kc">True</span>
 <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id1">
<h2>Examples<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h2>
<p><strong>Restart flight controller</strong></p>
<p><em>examples/restart.py</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is a simple test method that sends restart commands.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">mavlite</span> <span class="kn">import</span> <span class="n">MavLink</span><span class="p">,</span> <span class="n">UART</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">asyncio</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">uasyncio</span> <span class="k">as</span> <span class="nn">asyncio</span>  <span class="c1"># noqa</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">board</span>  <span class="c1"># noqa</span>
    <span class="n">_uart</span> <span class="o">=</span> <span class="n">UART</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="n">board</span><span class="o">.</span><span class="n">TX</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="n">board</span><span class="o">.</span><span class="n">RX</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">230400</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_uart</span> <span class="o">=</span> <span class="n">UART</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">230400</span><span class="p">)</span>


<span class="n">m_id</span> <span class="o">=</span> <span class="mi">246</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">MavLink</span><span class="p">([</span><span class="n">m_id</span><span class="p">,</span> <span class="mi">253</span><span class="p">])</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Send test command&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">m</span><span class="o">.</span><span class="n">heartbeat_wait</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">m</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
        <span class="n">command_id</span><span class="o">=</span><span class="mi">246</span><span class="p">,</span>
        <span class="n">target_system</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">target_component</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">uart_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test mainloop.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="n">m</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">(</span><span class="n">uart_</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">snd_cmd</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">send</span><span class="p">())</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">snd_cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">_uart</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Rangefinder</strong></p>
<p><em>examples/snc.py</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is an attempt to send some dummy sensor readings.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">asyncio</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">uasyncio</span> <span class="k">as</span> <span class="nn">asyncio</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">mavlite</span> <span class="kn">import</span> <span class="n">MavLink</span><span class="p">,</span> <span class="n">UART</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">monotonic</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">board</span>  <span class="c1"># noqa</span>
    <span class="n">_uart</span> <span class="o">=</span> <span class="n">UART</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="n">board</span><span class="o">.</span><span class="n">TX</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="n">board</span><span class="o">.</span><span class="n">RX</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">230400</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_uart</span> <span class="o">=</span> <span class="n">UART</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">230400</span><span class="p">)</span>


<span class="n">ml</span> <span class="o">=</span> <span class="n">MavLink</span><span class="p">(</span>
    <span class="n">message_ids</span><span class="o">=</span><span class="p">[</span>  <span class="c1"># Message includes.</span>
        <span class="mi">132</span><span class="p">,</span>  <span class="c1"># DISTANCE_SENSOR</span>
    <span class="p">],</span>
<span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">distance_sensor</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This will send the distance sensor messages to the flight controller.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># Transmit loop</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ml</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
                <span class="n">message_id</span><span class="o">=</span><span class="mi">132</span><span class="p">,</span>  <span class="c1"># DISTANCE_SENSOR</span>
                <span class="n">payload</span><span class="o">=</span><span class="p">[</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">monotonic</span><span class="p">()),</span>  <span class="c1"># boot_time</span>
                    <span class="mi">1</span><span class="p">,</span>  <span class="c1"># min_distance</span>
                    <span class="mi">100</span><span class="p">,</span>  <span class="c1"># max_distance</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>  <span class="c1"># current_distance</span>
                    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># type</span>
                    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># id</span>
                    <span class="mi">25</span><span class="p">,</span>  <span class="c1"># orientation  # Make fucking sure this matched the value in mission planner...</span>
                    <span class="mi">255</span><span class="p">,</span>  <span class="c1"># covariance</span>
                    <span class="mi">20</span><span class="p">,</span>  <span class="c1"># horizontal_fov</span>
                    <span class="mi">20</span><span class="p">,</span>  <span class="c1"># vertical_fov</span>
                    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># quaternion</span>
                    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># signal_quality</span>
                <span class="p">],</span>
                <span class="n">debug</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">break</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">uart_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test mainloop.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ml</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">(</span><span class="n">uart_</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [write_loop, read_loop, heartbeat_loop, command_listener]</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">distance_sensor</span><span class="p">(),</span> <span class="o">*</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">_uart</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>I2C Multiplexor</strong></p>
<p><em>examples/mplex.py</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is an example of how to use multiple vl53l1x sensors over a tca9548a multiplexor</span>

<span class="sd">ArduPilot NOTES:</span>

<span class="sd">* Rangefinder configurations must match transmission data in orientation.</span>
<span class="sd">* RNGFNDn_TYPE must be set to MavLink (10)</span>
<span class="sd">* PRX_TYPE Must be set to Mavlink (2)</span>

<span class="sd">It seems that only the orientation is evaluated, not the sensor id or originating component id.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">asyncio</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">uasyncio</span> <span class="k">as</span> <span class="nn">asyncio</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">mavlite</span> <span class="kn">import</span> <span class="n">MavLink</span><span class="p">,</span> <span class="n">UART</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">monotonic</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">board</span>  <span class="c1"># noqa</span>
    <span class="n">_uart</span> <span class="o">=</span> <span class="n">UART</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="n">board</span><span class="o">.</span><span class="n">TX</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="n">board</span><span class="o">.</span><span class="n">RX</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">230400</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_uart</span> <span class="o">=</span> <span class="n">UART</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">230400</span><span class="p">)</span>  <span class="c1"># For micropython, adjust pins as needed.</span>


<span class="n">TEST</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Change this if you just want to send random values instead of actually reading the multiplexor.</span>

<span class="n">i2c</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">tca</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">TEST</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">adafruit_tca9548a</span>
    <span class="kn">import</span> <span class="nn">adafruit_vl53l1x</span>
    <span class="c1"># Create I2C bus as normal</span>
    <span class="n">i2c</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">I2C</span><span class="p">()</span>  <span class="c1"># uses board.SCL and board.SDA</span>
    <span class="c1"># TODO: We need to add compat for micropython&#39;s I2C.</span>
    <span class="c1"># Create the TCA9548A object and give it the I2C bus</span>
    <span class="n">tca</span> <span class="o">=</span> <span class="n">tca9548a</span><span class="o">.</span><span class="n">TCA9548A</span><span class="p">(</span><span class="n">i2c</span><span class="p">)</span>

<span class="c1"># Create the mavlink object and include the definitions of the DISTANCE_SENSOR message</span>
<span class="n">ml</span> <span class="o">=</span> <span class="n">MavLink</span><span class="p">(</span>
    <span class="n">message_ids</span><span class="o">=</span><span class="p">[</span>  <span class="c1"># Message includes.</span>
        <span class="mi">132</span><span class="p">,</span>  <span class="c1"># DISTANCE_SENSOR</span>
    <span class="p">],</span>
<span class="p">)</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">I2c channel : orientation (-1 for disabled).</span>

<span class="sd">0    Forward</span>
<span class="sd">1    Forward-Right</span>
<span class="sd">2    Right</span>
<span class="sd">3    Back-Right</span>
<span class="sd">4    Back</span>
<span class="sd">5    Back-Left</span>
<span class="sd">6    Left</span>
<span class="sd">7    Forward-Left</span>
<span class="sd">24   Up</span>
<span class="sd">25   Down</span>

<span class="sd">NOTE: Ensure these orientations meet those configured on the flight controller.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">SENSORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>  <span class="c1"># down</span>
    <span class="mi">1</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>  <span class="c1"># up</span>
    <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># right</span>
    <span class="mi">3</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="c1"># left</span>
    <span class="mi">4</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="c1"># back</span>
    <span class="mi">5</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># front</span>
    <span class="mi">6</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">test_scan</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This will fire up the multiplexer and lidar sensors to prove everything is talking the way it should.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">needs_unlock</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">tca</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">try_lock</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Channel </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">addresses</span> <span class="o">=</span> <span class="n">tca</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">addresses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x29</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;found lidar____________________________________________________________________________________&#39;</span><span class="p">)</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unlocking channel&#39;</span><span class="p">)</span>
                    <span class="n">tca</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
                    <span class="n">needs_unlock</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;grabbing sensor&#39;</span><span class="p">)</span>
                    <span class="n">sensor_i2c</span> <span class="o">=</span> <span class="n">adafruit_vl53l1x</span><span class="o">.</span><span class="n">VL53L1X</span><span class="p">(</span><span class="n">tca</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="mh">0x29</span><span class="p">)</span>  <span class="c1"># Pass child bus instead of parent.</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start measuring&#39;</span><span class="p">)</span>
                    <span class="n">sensor_i2c</span><span class="o">.</span><span class="n">start_ranging</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;record data&#39;</span><span class="p">)</span>
                    <span class="c1"># while True:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># Place holder to get multiple samples if desired.</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;check sensor ready&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sensor_i2c</span><span class="o">.</span><span class="n">data_ready</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get distance&#39;</span><span class="p">)</span>
                            <span class="n">distance</span> <span class="o">=</span> <span class="n">sensor_i2c</span><span class="o">.</span><span class="n">distance</span>
                            <span class="k">if</span> <span class="n">distance</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading&#39;</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clearing interrupt&#39;</span><span class="p">)</span>
                            <span class="n">sensor_i2c</span><span class="o">.</span><span class="n">clear_interrupt</span><span class="p">()</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">needs_unlock</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unlocking channel&#39;</span><span class="p">)</span>
            <span class="n">tca</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;total modules found:&#39;</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LiDAR</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    One day this will handle the reading of the LiDAR array. Eight sensors will be read from the TCA9548A and one will be</span>
<span class="sd">    read from the native I2C bus all at address 0x29 / 41 This will allow us to sample a total of nine rangefinders</span>
<span class="sd">    through the microcontroller and a tenth via the flight controller&#39;s on-board I2C bus bringing us up to a total</span>
<span class="sd">    of ten.</span>

<span class="sd">    This will of course allow us to extend this module in the future to accommodate for other types of sensors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rangefinders</span> <span class="o">=</span> <span class="n">channel_nums</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">test</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Here we will fire up all of our sensors and tell them to start taking samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">i2c</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_nums</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tca</span><span class="p">[</span><span class="n">channel</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rangefinders</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span>  <span class="c1"># Confirm all our sensors are healthy</span>
                <span class="k">if</span> <span class="n">SENSORS</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Skip disabled channels.</span>
                    <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">try_lock</span><span class="p">():</span>
                        <span class="n">channel</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
                    <span class="n">rangefinder</span> <span class="o">=</span> <span class="n">adafruit_vl53l1x</span><span class="o">.</span><span class="n">VL53L1X</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">)</span>
                    <span class="n">rangefinder</span><span class="o">.</span><span class="n">start_ranging</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rangefinders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rangefinder</span><span class="p">)</span>
                    <span class="n">channel</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">mavlink_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chan</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will send the distance sensor messages to the flight controller.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="n">ml</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
            <span class="n">message_id</span><span class="o">=</span><span class="mi">132</span><span class="p">,</span>  <span class="c1"># DISTANCE_SENSOR</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">[</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">monotonic</span><span class="p">()),</span>  <span class="c1"># boot_time</span>
                <span class="mi">2</span><span class="p">,</span>  <span class="c1"># min_distance</span>
                <span class="mi">400</span><span class="p">,</span>  <span class="c1"># max_distance</span>
                <span class="n">value</span><span class="p">,</span>  <span class="c1"># current_distance</span>
                <span class="mi">0</span><span class="p">,</span>  <span class="c1"># type</span>
                <span class="n">chan</span><span class="p">,</span>  <span class="c1"># id  # This isn&#39;t a requirement, but it&#39;s tidy.</span>
                <span class="n">SENSORS</span><span class="p">[</span><span class="n">chan</span><span class="p">],</span>  <span class="c1"># orientation  # Make sure this matches the value in mission planner...</span>
                <span class="mi">255</span><span class="p">,</span>  <span class="c1"># covariance</span>
                <span class="mi">20</span><span class="p">,</span>  <span class="c1"># horizontal_fov</span>
                <span class="mi">20</span><span class="p">,</span>  <span class="c1"># vertical_fov</span>
                <span class="mi">0</span><span class="p">,</span>  <span class="c1"># quaternion</span>
                <span class="mi">0</span><span class="p">,</span>  <span class="c1"># signal_quality</span>
            <span class="p">],</span>
            <span class="c1"># c_id=chan + 25,  # This isn&#39;t a requirement, but it&#39;s tidy.</span>
            <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span>
        <span class="p">)</span>
        <span class="c1"># print(&#39;sensorID&#39;, chan, &#39;orient&#39;, SENSORS[chan], &#39;value&#39;, value)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">read_sensor</span><span class="p">(</span>
            <span class="n">channel</span><span class="p">:</span> <span class="p">[</span><span class="n">tca9548a</span><span class="o">.</span><span class="n">TCA9548A</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">I2C</span><span class="p">],</span>
            <span class="n">rangefinder</span><span class="p">:</span> <span class="n">adafruit_vl53l1x</span><span class="o">.</span><span class="n">VL53L1X</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will read an individual rangefinder and return the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">try_lock</span><span class="p">():</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">rangefinder</span><span class="o">.</span><span class="n">data_ready</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">rangefinder</span><span class="o">.</span><span class="n">distance</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Here we can add dynamic range mode and FOV changes should we want in the future.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rangefinder</span><span class="o">.</span><span class="n">clear_interrupt</span><span class="p">()</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will take a reading from the various sensors and passes them into the mavlink_send method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">channel</span><span class="p">,</span> <span class="n">rangefinder</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_nums</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rangefinders</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">SENSORS</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Skip disabled channels.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_sensor</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">rangefinder</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_send</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">read</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test mainloop.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ml</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">(</span><span class="n">_uart</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># [write_loop, read_loop, heartbeat_loop, command_listener]</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>


<span class="n">lidar</span> <span class="o">=</span> <span class="n">LiDAR</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">lidar</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
</pre></div>
</div>
</section>
</section>
<section id="links">
<h1>Links<a class="headerlink" href="#links" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="https://github.com/manbehindthemadness/Mavlite">https://github.com/manbehindthemadness/Mavlite</a> <br>
<a class="reference external" href="https://mavlink.io/en/messages/common.html">https://mavlink.io/en/messages/common.html</a> <br>
<a class="reference external" href="https://mavlink.io/en/messages/ardupilotmega.html">https://mavlink.io/en/messages/ardupilotmega.html</a> <br>
<a class="reference external" href="https://ardupilot.org/dev/docs/mavlink-commands.html">https://ardupilot.org/dev/docs/mavlink-commands.html</a> <br></p>
</section>
<section id="notes">
<h1>Notes<a class="headerlink" href="#notes" title="Permalink to this heading">¶</a></h1>
<p><strong>Known issues</strong></p>
<ul class="simple">
<li><p>Read loop needs serious optimization. - implemented, in testing</p></li>
<li><p>A request-command/receive method has not yet been implemented.</p></li>
</ul>
<p><strong>Future plans</strong></p>
<ul class="simple">
<li><p>Optimize read performance. - implemented, in testing</p></li>
<li><p>Accelerate code using C-extensions where possible.</p></li>
<li><p>Add custom XML dialog functionality.</p></li>
<li><p>Add request-command/receive functionality.</p></li>
</ul>
<p><strong>Caveats</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>At this time this module only supports UART communication, as such packet signing has not been included:</dt><dd><ul>
<li><p>Serves no function for hard-wired communication.</p></li>
<li><p>Performance would diminish without hardware SHA acceleration.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Currently only the following dialects have been included in the MSCFormats dictionary:</dt><dd><ul>
<li><p>minimal</p></li>
<li><p>ardupilotmega</p></li>
<li><p>common</p></li>
<li><p>uAvionix</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022 Kevin Eales, Cameron Clarke.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>